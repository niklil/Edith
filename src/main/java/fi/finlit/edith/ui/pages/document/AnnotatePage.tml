<html t:type="layout" xmlns:t="http://tapestry.apache.org/schema/tapestry_5_1_0.xsd"
	xmlns:p="tapestry:parameter">

	<p:title>${document.title}</p:title>

	<div class="content">
		<t:zone t:id="documentZone" update="show">
			<t:delegate to="documentView" />
		</t:zone>
		<t:block t:id="documentView">
			<t:document.view document="documentRevision" />
		</t:block>
	</div>

	<p:leftPanel>
	   <div id="document_links">
		  <span>
			 <a t:type="pageLink" t:page="document/viewPage" t:context="${document.id}">${message:to-view-document}</a>
		  </span>
		  <span>
			 <t:pagelink page="document/printPage" t:context="[document.id,documentRevision.revision]">${message:printVersion}
		     </t:pagelink>
		  </span>
	   </div>
	</p:leftPanel>

	<p:rightPanel>
		<div class="panel narrow">
			<h3>${message:query}</h3>
			<t:note.noteSearchForm notesList="notesList" searchInfo="searchInfo"/>
		</div>
		
		<t:form t:id="createTerm" t:zone="listZone">
			<t:hidden t:id="selectedText_1" value="createTermSelection.selection" />
			<t:hidden t:id="selectedStartId_1" value="createTermSelection.startId" />
			<t:hidden t:id="selectedEndId_1" value="createTermSelection.endId" />
			<t:hidden t:id="selectedStartIndex_1" value="createTermSelection.startIndex" />
			<t:hidden t:id="selectedEndIndex_1" value="createTermSelection.endIndex" />
			<a id="createTermLink" class="disabled selection-link" href="#">${message:createTerm}</a>
		</t:form>

		<div class="panel narrow">
			<h3>${message:notes}</h3>
			<t:zone t:id="listZone" update="show">
				<t:delegate to="notesList" />
			</t:zone>
			<div style="clear:both;"></div>
		</div>

		<t:zone t:id="editZone" update="show" />

		<t:block t:id="notesList">
			<t:if test="documentNotes">
				<ul class="notes">
					<t:loop source="documentNotes" value="note">
						<li>
							<a href="#start${note.localId}" class="notelink ${note.status}">
								<em>${note.note.lemma}</em>
							</a>
						</li>
					</t:loop>
				</ul>
				<p:else>${message:no-notes}</p:else>
			</t:if>
		</t:block>

		<t:block t:id="noteEdit">
			<t:if test="!selectedNotes.empty">
				<div class="panel narrow">

					<t:if test="moreThanOneSelectable">
						<h3>${message:selectNote}</h3>
						<ul class="notes">

							<t:loop source="selectedNotes" value="note">
								<li>
									<t:eventlink t:event="edit" context="editContext"
										t:zone="editZone" class="notelink">
										<em>${note.note.lemma}</em>
									</t:eventlink>
								</li>
							</t:loop>
						</ul>
					</t:if>
					<h3>${message:noteEdit}</h3>
					<div class="metadata">
						<t:dateTimeFormat date="noteOnEdit.createdOnDate"
							format="message:dateformat-compact" />
						${noteOnEdit.createdBy.username}
					</div>
					<div class="cleaner"></div>
					<div class="note_edit">
						<em>
							<strong>${noteOnEdit.note.lemma}</strong>
						</em>
						<!-- This could be externalized? -->
                        <script type="text/javascript">
                        jQuery(".delete_dialog").hide();

                        jQuery(".delete_question").click(function(event) {
                            jQuery(this).siblings().show();
                            jQuery(this).hide();
                            event.preventDefault();
                        });

                        jQuery(".delete_decline").click(function(event) {
                            jQuery(this).parent().siblings().show();
                            jQuery(this).parent().hide();
                            event.preventDefault();
                        });
                		</script>
						<span class="delete">
							<button class="delete_question">${message:delete}</button>
							<span class="delete_dialog">
								${message:delete}
								<t:eventlink t:event="delete" t:zone="editZone" context="noteOnEdit.id">${message:yes}</t:eventlink>
								/
								<a href="" class="delete_decline">${message:no}</a>
							</span>
						</span>

						<script type="text/javascript">
							var hideBasedOnFormat = function() {
							var type
							=jQuery("select[name='format']").val();
							jQuery("#editZone .note").hide();
							jQuery("#editZone .place").hide();
							jQuery("#editZone .person").hide();
							if (type ==
							"NOTE") {
							jQuery("#editZone .note").show();
							} else if (type ==
							"PLACE") {
							jQuery("#editZone .place").show();
							} else if (type ==
							"PERSON") {
							jQuery("#editZone .person").show();
							}
							}

							hideBasedOnFormat();

							jQuery("select[name='format']").change(function() {
							hideBasedOnFormat();
							});
                    </script>
						<t:note.noteForm							
							noteOnEdit="noteOnEdit" 
							termOnEdit="termOnEdit"
							documentRevision="documentRevision"
							createTermSelection="createTermSelection"
							updateLongTextSelection="updateLongTextSelection"
							infoMessage="infoMessage"
							selectedNotes="selectedNotes"
							comments="comments"
							searchInfo="searchInfo"
							documentNotes="documentNotes"
							
							notesList="notesList"
							noteEdit="noteEdit"
							errorBlock="errorBlock"
							documentView="documentView"
							commentZone="commentZone"/> 
					</div>
				</div>
			</t:if>
		</t:block>
		<t:zone t:id="commentZone" update="show">
		                <script type="text/javascript">
                            jQuery(".delete_dialog").hide();

                            jQuery(".delete_question").click(function(event) {
                                jQuery(this).siblings().show();
                                jQuery(this).hide();
                                event.preventDefault();
                            });

                            jQuery(".delete_decline").click(function(event) {
                                jQuery(this).parent().siblings().show();
                                jQuery(this).parent().hide();
                                event.preventDefault();
                            });
                       </script>
			<t:if test="noteId">
				<div id="comments">
					<h3>${message:comments}</h3>
					<t:loop source="comments" value="comment"
						volatile="true">
						<div>
							<div>${comment.message}</div>
							<div class="metadata">
								<t:dateTimeFormat date="comment.createdAt"
									format="message:dateformat-compact" />
								${comment.username}
							</div>
						<span class="delete">
                            <button class="delete_question">${message:delete}</button>
                            <span class="delete_dialog">
                                ${message:delete}
                                <t:eventlink t:event="deleteComment" t:zone="commentZone" 
                                    context="[noteId,comment.id]">${message:yes}</t:eventlink>
                                /
                                <a href="" class="delete_decline">${message:no}</a>
                            </span>
                        </span>
						</div>
					</t:loop>
					<div>
						<strong>${message:createNewComment-label}</strong>
					</div>
					<div>
						<t:form t:id="commentForm" t:zone="commentZone" t:context="noteId">
							<t:textField value="newCommentMessage" />
							<input type="submit" value="${message:save}" />
						</t:form>
					</div>
				</div>
			</t:if>
		</t:zone>

		<t:block id="infoBlock">
			${infoMessage}
        </t:block>

		<t:block id="errorBlock">
			<div class="error">${infoMessage}</div>
		</t:block>

		<t:block id="emptyBlock">
			<span />
		</t:block>

	</p:rightPanel>

	<script type="text/javascript">
		var l10n = new Array();
		l10n.invalidSelection =
		"${message:invalid-selection-error}";
	</script>
</html>
