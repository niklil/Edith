<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:t="http://tapestry.apache.org/schema/tapestry_5_1_0.xsd">
<t:content>





    <script type="text/javascript">


      jQuery(function() {

          //Empty values need to be filled, otherwise the page
          //will jump on load
          jQuery(".note_edit textarea.wysiwyg").each( function() {
              if (jQuery(this).val() === "") jQuery(this).val("<p></p>") });


          jQuery(".note_edit .wysiwyg").ckeditor(Edith_CKEditorSetup);

          jQuery(":input[name='save']").click(function(){
              jQuery("#.note_edit .wysiwyg").each( function() {
                  //console.log("updating element before save");
                  jQuery(this).ckeditorGet().updateElement();
              });
          });

          SLSNoteForm.toggleOtherLanguage();

          jQuery("select[name='language']").change(function() {
              SLSNoteForm.toggleOtherLanguage();
           });

          var hideBasedOnFormat = function() {
            var type = jQuery("select[name='format']").val();
            var $notes = jQuery(".note_edit .note");
            var $places = jQuery(".note_edit .place");
            var $persons = jQuery(".note_edit .person");
            $notes.hide();
            $places.hide();
            $persons.hide();
            if (type == "NOTE") {
                $notes.show();
            } else if (type == "PLACE") {
                $places.show();
            } else if (type == "PERSON") {
                $persons.show();
            }
        }

        hideBasedOnFormat();

        jQuery("select[name='format']").change(hideBasedOnFormat);
      });

    </script>



      <fieldset>

        <legend>${message:noteEdit}</legend>

        <div class="metadata">
          <t:dateTimeFormat date="noteOnEdit.editedOnDate"
            format="message:dateformat-compact" />
          ${noteOnEdit.lastEditedBy.username}
          (${noteOnEdit.editors})
        </div>



        <div class="note_edit">

          <t:form t:id="noteEditForm" t:zone="noteEditZone" t:context="[noteOnEdit.id]">
            <t:errors />

            <div class="field">
              <label for="format">${message:format-label}</label>
              <t:select t:id="format"/>
            </div>

            <div class="field">
              <t:label for="status">${message:status-label}</t:label>
              <t:select t:id="status" model="statusModel" value="noteOnEdit.status" />
            </div>

            <div class="field note">
               <t:label for="lemma">${message:lemma-label}</t:label>
               <t:textField t:id="lemma" value="noteOnEdit.lemma" />
            </div>

            <div class="field note">
               <t:label for="lemmaMeaning">${message:lemmaMeaning-label}</t:label>
               <t:textArea rows="1" t:id="lemmaMeaning" value="noteOnEdit.lemmaMeaning" />
            </div>

            <div class="field note">
              <label for="types">${message:type-label}</label>
              <div id="types">
                <t:loop source="types" value="type">
                    <label><t:checkbox value="selected" /> <t:fmt.message key="${type}" /></label>
                </t:loop>
              </div>
            </div>

<t:remove>
            <div class="field note">
              <t:label for="basicForm">${message:basicForm-label}</t:label>
              <t:textField t:id="basicForm" value="noteOnEdit.term?.basicForm" />
            </div>

            <div class="field note">
              <t:label for="termMeaning">${message:basicFormMeaning-label}</t:label>
              <t:textArea class="wysiwyg" style="display:none" t:id="termMeaning" value="noteOnEdit.term?.meaning" />
            </div>

            <div class="field note">
              <t:label for="language">${message:basicFormLanguage-label}</t:label>
              <t:select t:id="language" value="language" blankOption="ALWAYS"/>
              <t:textField style="margin-left: 1em; width: 10em" t:id="otherLanguage" value="noteOnEdit.term?.otherLanguage" />
            </div>
</t:remove>





            <div class="note">
            <strong>${message:termSearch}</strong>
            <t:textField t:id="term" value="search" t:mixins="termAutocomplete" />
            <t:textfield t:id="termId" value="termId" style="display: none;"/>

            </div>
            <t:zone id="termZone" t:id="termZone" t:zone="termZone" update="show">
            <t:block t:id="editTermForm">
                <t:note.termForm closeDialog="closeDialog" termId="termId" termZone="termZone"/>
            </t:block>
            <script type="text/javascript">
            jQuery(function() {
              jQuery("input[name='termId']").attr("value", jQuery("#termId").attr("name"));
              jQuery(".editTerm").click(function() {
                jQuery("#dialog").jqm().jqmShow();
              });
            });
            </script>
            <div id="termId" name="${termId}" style="display: none;"/>
            <t:if test="term">
            <div class="note">
                <t:if test="termBasicForm">
                    <div>${message:basicForm-label}</div>
                    <div>${termBasicForm}</div>
                </t:if>
                <t:if test="termMeaning">
                    <div>${message:meaning-label}</div>
                    <div>${termMeaning}</div>
                </t:if>
                <t:if test="termLanguage">
                    <div>${message:basicFormLanguage-label}</div>
                    <div><t:fmt.message key="${termLanguage}" /></div>
                </t:if>
                
            </div>

            <t:eventlink t:event="editTerm" t:zone="dialogZone" class="jqModal note editTerm" t:context="termId">${message:editTerm}</t:eventlink>
            </t:if>
            </t:zone>

            <div class="field person">
                <label>${message:personSearch}</label>
                <t:textField t:id="person" value="search" t:mixins="personAutocomplete" />
                <t:textfield t:id="personId" value="personId" style="display: none;"/>
            </div>

            <t:zone id="personZone" t:id="personZone" t:zone="personZone">

            <t:block t:id="closeDialog">
                <script type="text/javascript">jQuery('#dialog').jqmHide();</script>
            </t:block>

            <t:block t:id="editPersonForm">
                <t:note.personForm closeDialog="closeDialog" personId="personId" personZone="personZone"/>
            </t:block>

            <script type="text/javascript">
            jQuery(function() {
              jQuery("input[name='personId']").attr("value", jQuery("#personId").attr("name"));
              jQuery(".jqmOpen").click(function() {
                jQuery("#dialogZone").text("Hetki...");
                jQuery("#dialog").jqm().jqmShow();
              });
            });

            </script>
            <div id="personId" name="${personId}" style="display: none;"/>
            <t:if test="person">
            <div class="field person">
                <div><strong>${message:normalizedForm-label}</strong> <span class="metadata"> (<t:fmt.message key="embeddedTo" args="personInstances"/>)</span></div>
                <t:if test="normalizedFirst">
                    <div>${message:firstName-label}</div>
                    <div>${normalizedFirst}</div>
                </t:if>
                <t:if test="normalizedLast">
                    <div>${message:lastName-label}</div>
                    <div>${normalizedLast}</div>
                </t:if>
                <t:if test="normalizedDescription">
                    <div>${message:normalizedDescription-label}</div>
                    <div>${normalizedDescription}</div>
                </t:if>
            </div>

            <div class="field person">
            <t:loop source="persons" value="loopPerson" formState="none">
                <div>
                    <div><strong>${message:nameForm-label}</strong></div>
                    <t:if test="loopPerson.first">
                        <div>${message:firstName-label}</div>
                        <div>${loopPerson.first}</div>
                    </t:if>
                    <t:if test="loopPerson.last">
                        <div>${message:lastName-label}</div>
                        <div>${loopPerson.last}</div>
                    </t:if>
                    <t:if test="loopPerson.description">
                        <div>${message:nameFormDescription-label}</div>
                        <div>${loopPerson.description}</div>
                    </t:if>
                </div>
            </t:loop>
            </div>

            <t:if test="timeOfBirth">
            <div class="field person">
                <div>
                    <strong>${message:timeOfBirth-label} (${message:timeFormat})</strong>
                </div>
                <div>
                    ${timeOfBirth}
                </div>
            </div>
            </t:if>

            <t:if test="timeOfDeath">
            <div class="field person">
                <div>
                    <strong>${message:timeOfDeath-label} (${message:timeFormat})</strong>
                </div>
                <div>
                    ${timeOfDeath}
                </div>
            </div>
            </t:if>

            <t:eventlink t:event="editPerson" t:zone="dialogZone" class="jqmOpen person editPerson" t:context="personId">${message:editPerson}</t:eventlink>
            </t:if>
            </t:zone>

            <div class="place">
            <strong>${message:placeSearch}</strong>
            <t:textField t:id="place" value="search" t:mixins="placeAutocomplete" />
            <t:textfield t:id="placeId" value="placeId" style="display: none;"/>

            </div>
            <t:zone id="placeZone" t:id="placeZone" t:zone="placeZone" update="show">
            <t:block t:id="editPlaceForm">
                <t:note.placeForm closeDialog="closeDialog" placeId="placeId" placeZone="placeZone"/>
            </t:block>
            <script type="text/javascript">
            jQuery(function() {
              jQuery("input[name='placeId']").attr("value", jQuery("#placeId").attr("name"));
              jQuery(".editPlace").click(function() {
                jQuery("#dialogZone").text("Hetki...");
                jQuery("#dialog").jqm().jqmShow();
              });
            });
            </script>
            <div id="placeId" name="${placeId}" style="display: none;"/>
            <t:if test="place">
            <div class="place">
                <div><strong>${message:normalizedForm-label}</strong> <span class="metadata"> (<t:fmt.message key="embeddedTo" args="placeInstances"/>)</span></div>
                <t:if test="normalizedPlaceName">
                    <div>${message:name-label}</div>
                    <div>${normalizedPlaceName}</div>
                </t:if>
                <t:if test="normalizedPlaceDescription">
                    <div>${message:nameFormDescription-label}</div>
                    <div>${normalizedPlaceDescription}</div>
                </t:if>
            </div>

            <div class="place">
            <t:loop source="places" value="loopPlace" formState="none">
                <div>
                    <div><strong>${message:nameForm-label}</strong></div>
                    <t:if test="loopPlace.name">
                        <div>${message:name-label}</div>
                        <div>${loopPlace.name}</div>
                    </t:if>
                    <t:if test="loopPlace.description">
                        <div>${message:description-label}</div>
                        <div>${loopPlace.description}</div>
                    </t:if>
                </div>
            </t:loop>
            </div>

            <t:eventlink t:event="editPlace" t:zone="dialogZone" class="jqModal place editPlace" t:context="placeId">${message:editPlace}</t:eventlink>
            </t:if>
            </t:zone>

            <div class="field note person place">
              <t:label for="description">${message:description-label}</t:label>
              <t:textArea class="wysiwyg" style="display:none" t:id="description" value="noteOnEdit.description" />
            </div>

            <!-- TODO In the future
            <div class="field">
              <label>${message:linkTo-label}</label>
              <div>TBD</div>
            </div>
            -->

            <div class="field note person place">
              <t:label for="sources">${message:sources-label}</t:label>
              <t:textArea class="wysiwyg" style="display:none" t:id="sources" value="noteOnEdit.sources" rows="8" />
            </div>

            <t:remove><!-- FIXME -->
            <div class="field">
              <label><t:checkbox value="saveTermAsNew" />${message:saveTermAsNew}</label>
            </div>
            </t:remove>


            <t:submit t:id="save" value="${message:save}" />
            <t:if test="deletableNote">
                <t:submit class="right" t:id="delete" value="${message:delete}" />
            </t:if>

          </t:form>

        </div>
      </fieldset>


</t:content>

</html>





